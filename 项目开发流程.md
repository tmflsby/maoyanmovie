# 项目开发流程

## 1. 创建客户端项目

###  1.1 使用 vue-cli(脚手架)搭建项目 

```bash
#在Github新建maoyanmovie项目,然后clone到本地
https://github.com/tmflsby/maoyanmovie.git

vue create maoyanmovie

Vue CLI v3.11.0
┌───────────────────────────┐
│  Update available: 4.1.1  │
└───────────────────────────┘
? Please pick a preset: Manually select features
? Check the features needed for your project: Babel, Router, Vuex, CSS Pre-processors
? Use history mode for router? (Requires proper server setup for index fallback in production) Yes
? Pick a CSS pre-processor (PostCSS, Autoprefixer and CSS Modules are supported by default): Sass/SCSS (with dart dart-sass)
? Where do you prefer placing config for Babel, PostCSS, ESLint, etc.? In package.json
? Save this as a preset for future projects? No


$ cd maoyanmovie
$ npm run serve  访问: http://localhost:8080/
```

### 1.2 项目结构分析 

>  ** maoyanmovie **
>
> 
>  - |-- node_modules: 项目依赖 
>  - |-- public
>     - |-- favicon.ico: 网站图标
>     - |-- index.html: 默认的主渲染页面文件
>  - |-- src: 源码文件夹 
>     - |-- assets: 静态资源文件夹
>     - |-- components: 存放公用组件
>     - |-- router: 存放路由
>     - |-- store: 存放vuex数据
>     - |-- views: 存放路由组件
>     - |-- App.vue: 入口vue文件
>     - |-- main.js: 应用入口 js  （初始化vue实例并使用需要的插件 ）
>  - |-- babel.config.js: babel 的配置文件
>  - |-- .gitignore: git 版本管理忽略的配置 
>  - |-- package-lock.json: 版本管理使用的文件
>  - |-- package.json: 项目描述及依赖
>  - |-- README.md: 应用描述说明的 readme 文件 

### 1.3 编码测试与打包发布项目  

- 编码测试 

  npm run serve 

  访问: http://localhost:8080 

  编码, 自动编译打包(HMR), 查看效果 

- 打包发布 

  npm run build 

  npm install -g serve 

  serve dist

  访问: http://localhost:5000  

## 2. 功能需求分析

- 开发前应该首先完成功能模块的分析设计，这里我们可以直接运行项目查看功能演示 自己总结项目功能需求

- [线上项目演示](http://39.97.33.178/miaomiao)

- 本项目对线上项目做了更好的改进

## 3. 开发资源iconfont准备

- 使用[阿里巴巴矢量库]( http://www.iconfont.cn/)

- 将想要的图标添加入库（购物车） 

- 将购物车中的图标添加到项目中 

- 生成项目图标的[iconfont.css](./public/css/iconfont/iconfont.css)地址

- 在项目目录下的public文件夹内新建css文件夹

- 在css文件夹内新建iconfont文件夹,存放iconfont.css以及字体图标

- 在index.html 中引入 

  ```html
  <link rel="stylesheet" href="<%= BASE_URL %>css/iconfont/iconfont.css">
  ```

## 4. Css Reset、Fastclick  

- 注意在组件内编写样式时要声明lang和scoped

  ```html
  <style lang="scss" scoped>
  </style>
  ```

### 4.1 Css Reset

- 在css文件夹内新建重置样式文件common.css 

- 在index.html 中引入 

  ```html
  <link rel="stylesheet" href="<%= BASE_URL %>css/common.css">
  ```

### 4.2 Fastclick

> 当用户一次点击屏幕之后，浏览器并不能立刻判断用户是要进行双击缩放，还是想要进行单击操作。因此，iOS Safari 就等待 300 毫秒，以判断用户是否再次点击了屏幕。 于是，300 毫秒延迟就这么诞生了。

- 安装fastclick库  解决点击响应延时 0.3s 问题 

  ```bash
  npm install fastclick --save
  ```

- 在main.js中引入，并绑定到body

  ```js
  import FastClick from 'fastclick'

  FastClick.attach(document.body);
  ```

## 5. Vue组件化

### 5.1 分析整个项目的 vue 组件结构 

> **src**
> - |-- assets: 静态资源文件夹
> - |-- components------------非路由组件文件夹 
>    - |-- Header---------------头部组件文件夹 
>      - |-- index.vue--------头部组件 vue 
>    - |-- TabBar---------------底部组件文件夹 
>      - |-- index.vue--------底部组件 vue 
> - |-- routers------------路由文件夹 
>    - |-- cinema---------------cinema路由文件夹 
>      - |-- index.js--------cinema路由 js 
>    - |-- mine---------------mine路由文件夹 
>      - |-- index.js--------mine路由 js 
>    - |-- movie---------------movie路由文件夹 
>      - |-- index.js--------movie路由 js 
>    - |--index.js-----------路由根index文件 js
> - |-- stores-----------------vuex文件夹 
>   - |-- index.js-----------------vuex  js
> - |-- views-----------------路由组件文件夹 
>   - |-- Cinema---------------Cinema组件文件夹 
>     - |-- index.vue--------影院组件 vue
>   - |-- Movie--------------Movie组件文件夹
>     - |-- index.vue-------电影组件 vue
>   - |-- Mine--------------Mine组件文件夹 
>     - |-- index.vue-------个人组件 vue 
> - |-- App.vue---------------应用根组件 vue 
> - |-- main.js---------------应用入口 js 

1. 页面底部的TabBar组件只是用来放views里的组件的容器，所以它不是路由组件
2. 页面最上面的标题栏在我们的项目中属于路由组件的组成部分（与中间内容部分在一起）
3. 但每个路由组件中都有最顶部的组件且相似度很高，所以可以将其抽取成为一个单独的组件

### 5.2 编写vue组件模板文件

- views文件夹下的各个vue组件文件及App.vue和FooterGuide.vue都是这个初始空白模板

```vue
<template>
  <div>
    App vue template
  </div>
</template>

<script>
  export default {
    name: 'Name'
  }
</script>

<style lang="scss" scoped>

</style>
```

## 6. 引入Vue-router

### 6.1 下载vue-router 

```bash
#vue-cli创建项目时已下载
npm install vue-router --save
```

### 6.2 编写routers文件夹下的index.js  ————  一级路由的配置

- 在routers文件夹下创建movie/mine/cinema文件夹，模块化配置相对应的路由

- 路由懒加载 `component: () => import('@/views/Cinema')`

```javascript
/**
* index.js 
*/
import Vue from 'vue'
import Router from 'vue-router'
//引入路由模块
import movieRouter from './movie'
import mineRouter from './mine'
import cinemaRouter from './cinema'

// 全局注册Vue-router组件
Vue.use(VueRouter)

export default new Router({
  mode: 'history',
  base: process.env.BASE_URL,

  routes: [
    movieRouter,
    mineRouter,
    cinemaRouter,
    // 重定向
    {
      path: '/*',
      redirect: '/movie'
    }
  ]
})


/**
* cinema--->index.js 
*/
export default {
  path: '/cinema',
  component: () => import('@/views/Cinema')
}


/**
* mine--->index.js 
*/
export default {
  path: '/mine',
  component: () => import('@/views/Mine')
}


/**
* movie--->index.js 
*/
export default {
  path: '/movie',
  component: () => import('@/views/Movie')
}

```

### 6.3 编写应用的入口文件main.js

```javascript
// 引入路由 其实就是引入上一步配置好的路由表
import router from './router'

new Vue({
  // 为根组件加入路由
  router,
  render: h => h(App)
}).$mount('#app')
```

### 6.4 在App.vue里使用router-view

```vue
<template>
    <router-view></router-view>
</template>

<style lang="scss">

</style>
```

### 6.5 运行并请求不同路由路径查看效果

通过切换url地址里的hash值（cinema/mine/movie），页面会显示不同的路由模板内容。

### 6.6 movie下的二级路由的配置  ———— city/nowPlaying/comingSoon/search

- 在routers的movie文件夹下的index中配置二级路由

```javascript
export default {
  path: '/movie',
  component: () => import('@/views/Movie'),
  children: [
    {
      path: 'city',
      component: () => import('@/components/City')
    },
    {
      path: 'nowPlaying',
      component: () => import('@/components/NowPlaying')
    },
    {
      path: 'comingSoon',
      component: () => import('@/components/ComingSoon')
    },
    {
      path: 'search',
      component: () => import('@/components/Search')
    },
    //重定向到  /movie/nowPlaying
    {
      path: '/movie',
      redirect: '/movie/nowPlaying'
    }
  ]
}

```

## 7. 初步编写各组件代码

### 7.1 TabBar组件和Header组件

**TabBar功能及实现**

1. 通过<router-link to></router-link>实现路由的切换显示
2. 通过动态 class 和 <router-link to></router-link> 来实现 tab 样式切换 
3. 通过阿里图标库, 显示导航图标 

**TabBar代码**

```vue
<template>
  <div>
    <footer id="footer">
      <ul>
        <router-link tag="li" to="/movie">
          <i class="iconfont icon-dianying"></i>
          <p>电影</p>
        </router-link>
        <router-link tag="li" to="/cinema">
          <i class="iconfont icon-yingyuan"></i>
          <p>影院</p>
        </router-link>
        <router-link tag="li" to="/mine">
          <i class="iconfont icon-wode"></i>
          <p>我的</p>
        </router-link>
      </ul>
    </footer>
  </div>
</template>

<script>
export default {
  name: 'TabBar'
}
</script>

<style lang="scss" scoped>
#footer {
  width: 100%;
  height: 50px;
  background: white;
  border-top: 2px #ebe8e3 solid;
  position: fixed;
  left: 0;
  bottom: 0;
}
#footer ul {
  display: flex;
  text-align: center;
  height: 50px;
  align-items: center;
}
#footer ul li {
  flex: 1;
  height: 40px;
}
#footer ul li.active {
  color: #f03d37;
}
#footer ul li.router-link-active {
  color: #f03d37;
}
#footer ul i {
  font-size: 20px;
}
#footer ul p {
  font-size: 12px;
  line-height: 18px;
}
</style>

```

**Header功能及实现**

1. 通过<slot></slot>插槽分发头部title
2. 通过props接收父组件的title动态改变头部title的值
3. 默认title值为'猫眼电影' 

**Header代码**
```vue
<template>
  <div>
    <header id="header">
      <slot></slot>
      <h1>{{title}}</h1>
    </header>
  </div>
</template>

<script>
export default {
  name: 'Header',
  props: {
    title: {
      type: String,
      default: '猫眼电影'
    }
  }
}
</script>

<style lang="scss" scoped>
#header {
  width: 100%;
  height: 50px;
  color: #fff;
  background: #e54847;
  border-bottom: 1px solid #e54847;
  position: relative;
}
#header h1 {
  font-size: 18px;
  text-align: center;
  line-height: 50px;
  font-weight: normal;
}
#header i {
  position: absolute;
  left: 5px;
  top: 50%;
  margin-top: -13px;
  font-size: 26px;
}
</style>

```

- 在Cinema，Mine，Movie组件中分别引入TabBar组件和Header组件

```vue
<template>
  <div id="main">
    <Header title="猫眼电影"></Header>

    <TabBar></TabBar>
  </div>
</template>
import Header from '@/components/Header'
import TabBar from '@/components/TabBar'
export default {
  name: 'Cinema',
  components: {
    Header,
    TabBar
  }
}

...Mine，Movie省略

```

- 至此，底部头部组件完成，可实现点击不同的选项切换不同的路由组件。

- 为防止每次切换路由都重新渲染组件，使用<keep-alive></keep-alive>进行缓存

```vue
//App.vue
<keep-alive>
        <router-view/>
</keep-alive>

```

### 7.2 各级路由组件

#### 7.2.1 Mine组件

**功能区域划分**

1. 最顶部的title标题栏部分
2. 中间的login部分————可拆分为Login组件
3. 底部的导航栏

**代码**

```vue
<template>
  <div id="main">
    <Header title="我的猫眼"></Header>
    <div class="content">
      <Login></Login>
    </div>
    <TabBar></TabBar>
  </div>
</template>

<script>
import Header from '@/components/Header'
import TabBar from '@/components/TabBar'
import Login from '@/components/Login'

export default {
  name: 'Mine',
  components: {
    Header,
    TabBar,
    Login
  }
}
</script>

<style lang="scss" scoped>

</style>

```

#### 7.2.2 Login组件

**代码**

```vue
<template>
  <div id="content">
    <div class="login_body">
      <div>
        <input class="login_text" type="text" placeholder="账户名/手机号/Email" />
      </div>
      <div>
        <input class="login_text" type="password" placeholder="请输入您的密码" />
      </div>
      <div class="login_btn">
        <input type="submit" value="登录" />
      </div>
      <div class="login_link">
        <a href="#">立即注册</a>
        <a href="#">找回密码</a>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'Login'
}
</script>

<style lang="scss" scoped>
#content .login_body {
  width: 100%;
}
.login_body .login_text {
  width: 100%;
  height: 40px;
  border: none;
  border-bottom: 1px #ccc solid;
  margin-bottom: 5px;
  outline: none;
  text-indent: 10px;
}
.login_body .login_btn {
  height: 50px;
  margin: 10px;
}
.login_body .login_btn input {
  width: 100%;
  height: 100%;
  background: #e54847;
  border-radius: 3px;
  border: none;
  display: block;
  color: white;
  font-size: 20px;
}
.login_body .login_link {
  display: flex;
  justify-content: space-between;
}
.login_body .login_link a {
  text-decoration: none;
  margin: 0 5px;
  font-size: 12px;
  color: #e54847;
}
</style>

```

#### 7.2.3 Cinema组件

**功能区域划分**

1. 最顶部的title标题栏部分
2. 中间的CinemaList(电影院列表)部分————可拆分为CinemaList组件
3. 底部的导航栏

**代码**

```vue
<template>
  <div id="main">
    <Header title="猫眼影院"></Header>
    <div id="content">
      <div class="cinema_menu">
        <div class="city_switch">
          全城
          <i class="iconfont icon-lower-triangle"></i>
        </div>
        <div class="brand_swtich">
          品牌
          <i class="iconfont icon-lower-triangle"></i>
        </div>
        <div class="feature_switch">
          特色
          <i class="iconfont icon-lower-triangle"></i>
        </div>
      </div>
      <CinemaList></CinemaList>
    </div>
    <TabBar></TabBar>
  </div>
</template>

<script>
import Header from '@/components/Header'
import TabBar from '@/components/TabBar'
import CinemaList from '@/components/CinemaList'

export default {
  name: 'Cinema',
  components: {
    Header,
    TabBar,
    CinemaList
  }
}
</script>

<style lang="scss" scoped>
#content .cinema_menu {
  width: 100%;
  height: 45px;
  border-bottom: 1px solid #e6e6e6;
  display: flex;
  justify-content: space-around;
  align-items: center;
  background: white;
}
</style>

```

#### 7.2.4 CinemaList组件

**代码**

```vue
<template>
  <div class="cinema_body">
    <ul>
      <li>
        <div>
          <span>大地影院(澳东世纪店)</span>
          <span class="q">
            <span class="price">22.8</span> 元起
          </span>
        </div>
        <div class="address">
          <span>金州区大连经济技术开发区澳东世纪3层</span>
          <span>1763.5km</span>
        </div>
        <div class="card">
          <div>小吃</div>
          <div>折扣卡</div>
        </div>
      </li>
    </ul>
  </div>
</template>

<style lang="scss" scoped>
#content .cinema_body {
  flex: 1;
  overflow: auto;
}
.cinema_body ul {
  padding: 0 20px;
}
.cinema_body li {
  border-bottom: 1px solid #e6e6e6;
  // margin-bottom: 20px;
}

.cinema_body li .title{
  margin: 10px 0;
}

.cinema_body div {
  margin-bottom: 10px;
}
.cinema_body .q {
  font-size: 11px;
  color: #f03d37;
}
.cinema_body .price {
  font-size: 18px;
}
.cinema_body .address {
  font-size: 13px;
  color: #666;
  display: flex;
}
.cinema_body .address span:first-of-type {
  display: block;
  width: 400px;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}
.cinema_body .address span:nth-of-type(2) {
  // float: right;
  width: 100px;
  text-align: right;
}
.cinema_body .card {
  display: flex;
}
.cinema_body .card div {
  padding: 0 3px;
  height: 15px;
  line-height: 15px;
  border-radius: 2px;
  color: #f90;
  border: 1px solid #f90;
  font-size: 13px;
  margin-right: 5px;
}
.cinema_body .card div.or {
  color: #f90;
  border: 1px solid #f90;
}
.cinema_body .card div.bl {
  color: #589daf;
  border: 1px solid #589daf;
}
</style>

```

#### 7.2.5 Movie组件

**功能区域划分**

1. 最顶部的title标题栏部分
2. 底部的导航栏
3. 顶部title下的二级路由nav
4. 二级路由可以抽成四个组件———— City/NowPlaying/Coming Soon/Search

**代码**

```vue
<template>
  <div id="main">
    <Header title="猫眼电影"></Header>
    <div id="content">
      <div class="movie_menu">
        <router-link to="/movie/city" tag="div" class="city_name">
          <span>城市</span>
          <i class="iconfont icon-lower-triangle"></i>
        </router-link>
        <div class="hot_swtich">
          <router-link to="/movie/nowPlaying" tag="div" class="hot_item active">正在热映</router-link>
          <router-link to="/movie/comingSoon" tag="div" class="hot_item">即将上映</router-link>
        </div>
        <router-link to="/movie/search" tag="div" class="search_entry">
          <i class="iconfont icon-sousuo"></i>
        </router-link>
      </div>
      <keep-alive>
        <router-view></router-view>
      </keep-alive>
    </div>
    <TabBar></TabBar>
  </div>
</template>

<script>
import Header from '@/components/Header'
import TabBar from '@/components/TabBar'

export default {
  name: 'Movie',
  components: {
    Header,
    TabBar
  }
</script>

<style lang="scss" scoped>
#content {
  flex: 1;
  overflow: auto;
  margin-bottom: 50px;
  position: relative;
  display: flex;
  flex-direction: column;
}
#content .movie_menu {
  width: 100%;
  height: 45px;
  border-bottom: 1px solid #e6e6e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: white;
  z-index: 10;
}
.movie_menu .city_name {
  margin-left: 20px;
  height: 100%;
  line-height: 45px;
}
.movie_menu .city_name.router-link-active {
  color: #ef4238;
  // border-bottom: 2px #ef4238 solid;
}
.movie_menu .hot_swtich {
  display: flex;
  height: 100%;
  line-height: 45px;
}
.movie_menu .hot_item {
  font-size: 15px;
  color: #666;
  width: 80px;
  text-align: center;
  margin: 0 12px;
  font-weight: 700;
}
.movie_menu .hot_item.router-link-active {
  color: #ef4238;
  border-bottom: 2px #ef4238 solid;
}
.movie_menu .search_entry {
  margin-right: 20px;
  height: 100%;
  line-height: 45px;
}
.movie_menu .search_entry.router-link-active {
  color: #ef4238;
  // border-bottom: 2px #ef4238 solid;
}
.movie_menu .search_entry i {
  font-size: 24px;
  color: red;
}
</style>

```

#### 7.2.6 City组件

**代码**

```vue
<template>
  <div class="city_body">
    <div class="city_list">
      <div class="city_hot">
        <h2>热门城市</h2>
        <ul class="clearfix">
          <li>上海</li>
          <li>北京</li>
        </ul>
      </div>
      <div class="city_sort">
        <div>
          <h2>A</h2>
          <ul>
            <li>阿拉善盟</li>
            <li>鞍山</li>
          </ul>
        </div>
        <div>
          <h2>B</h2>
          <ul>
            <li>北京</li>
            <li>保定</li>
          </ul>
        </div>
      </div>
    </div>
    <div class="city_index">
      <ul>
        <li>A</li>
        <li>B</li>
      </ul>
    </div>
  </div>
</template>

<script>
export default{
  name: 'City'
}
</script>

<style lang="scss" scoped>
#content .city_body {
  margin-top: 45px;
  display: flex;
  width: 100%;
  position: absolute;
  top: 0;
  bottom: 0;
}
.city_body .city_list {
  flex: 1;
  overflow: auto;
  background: #fff5f0;
}
.city_body .city_list::-webkit-scrollbar {
  background-color: transparent;
  width: 0;
}
.city_body .city_hot {
  margin-top: 20px;
}
.city_body .city_hot h2 {
  padding-left: 15px;
  line-height: 30px;
  font-size: 14px;
  background: #f0f0f0;
  font-weight: normal;
}
.city_body .city_hot ul li {
  float: left;
  background: #fff;
  width: 29%;
  height: 33px;
  margin-top: 15px;
  margin-left: 3%;
  padding: 0 4px;
  border: 1px solid #e6e6e6;
  border-radius: 3px;
  line-height: 33px;
  text-align: center;
  box-sizing: border-box;
}
.city_body .city_sort div {
  margin-top: 20px;
}
.city_body .city_sort h2 {
  padding-left: 15px;
  line-height: 30px;
  font-size: 14px;
  background: #f0f0f0;
  font-weight: normal;
}
.city_body .city_sort ul {
  padding-left: 10px;
  margin-top: 10px;
}
.city_body .city_sort ul li {
  line-height: 30px;
  line-height: 30px;
}
.city_body .city_index {
  width: 20px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  text-align: center;
  border-left: 1px #e6e6e6 solid;
}
</style>

```

#### 7.2.7 NowPlaying组件

**代码**

```vue
<template>
  <div class="movie_body">
    <ul>
      <li>
        <div class="pic_show"><img src="images/movie_1.jpg"></div>
        <div class="info_list">
          <h2>无名之辈</h2>
          <p>观众评 <span class="grade">9.2</span></p>
          <p>主演: 陈建斌,任素汐,潘斌龙</p>
          <p>今天55家影院放映607场</p>
        </div>
        <div class="btn_mall">
          购票
        </div>
      </li>
      <li>
        <div class="pic_show"><img src="images/movie_2.jpg"></div>
        <div class="info_list">
          <h2>毒液：致命守护者</h2>
          <p>观众评 <span class="grade">9.3</span></p>
          <p>主演: 汤姆·哈迪,米歇尔·威廉姆斯,里兹·阿迈德</p>
          <p>今天56家影院放映443场</p>
        </div>
        <div class="btn_mall">
          购票
        </div>
      </li>
    </ul>
  </div>
</template>

<script>
export default{
  name: 'NowPlaying'
}
</script>

<style lang="scss" scoped>
#content .movie_body {
  flex: 1;
  overflow: auto;
}
.movie_body ul {
  margin: 0 12px;
  overflow: hidden;
}
.movie_body ul li {
  margin-top: 12px;
  display: flex;
  align-items: center;
  border-bottom: 1px #e6e6e6 solid;
  padding-bottom: 10px;
}
.movie_body .pic_show {
  width: 64px;
  height: 90px;
}
.movie_body .pic_show img {
  width: 100%;
}
.movie_body .info_list {
  margin-left: 10px;
  flex: 1;
  position: relative;
}
.movie_body .info_list h2 {
  font-size: 17px;
  line-height: 24px;
  width: 150px;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}
.movie_body .info_list p {
  font-size: 13px;
  color: #666;
  line-height: 22px;
  width: 200px;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}
.movie_body .info_list .grade {
  font-weight: 700;
  color: #faaf00;
  font-size: 15px;
}
.movie_body .info_list img {
  width: 50px;
  position: absolute;
  right: 10px;
  top: 5px;
}
.movie_body .btn_mall,
.movie_body .btn_pre {
  width: 47px;
  height: 27px;
  line-height: 28px;
  text-align: center;
  background-color: #f03d37;
  color: #fff;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
}
.movie_body .btn_pre {
  background-color: #3c9fe6;
}
.movie_body .pullDown {
  margin: 0;
  padding: 0;
  border: none;
}
</style>

```

#### 7.2.8 ComingSoon组件

**代码**

```vue
<template>
  <div class="movie_body">
    <ul>
      <li>
        <div class="pic_show"><img src="images/movie_1.jpg"></div>
        <div class="info_list">
          <h2>无名之辈</h2>
          <p><span class="person">17746</span> 人想看</p>
          <p>主演: 陈建斌,任素汐,潘斌龙</p>
          <p>2018-11-30上映</p>
        </div>
        <div class="btn_pre">
          预售
        </div>
      </li>
      <li>
        <div class="pic_show"><img src="images/movie_2.jpg"></div>
        <div class="info_list">
          <h2>毒液：致命守护者</h2>
          <p><span class="person">2346</span> 人想看</p>
          <p>主演: 汤姆·哈迪,米歇尔·威廉姆斯,里兹·阿迈德</p>
          <p>2018-11-30上映</p>
        </div>
        <div class="btn_pre">
          预售
        </div>
      </li>
    </ul>
  </div>
</template>

<script>
export default {
  name: 'ComingSoon'
}
</script>

<style lang="scss" scoped>
#content .movie_body {
  flex: 1;
  overflow: auto;
}
.movie_body ul {
  margin: 0 12px;
  overflow: hidden;
}
.movie_body ul li {
  margin-top: 12px;
  display: flex;
  align-items: center;
  border-bottom: 1px #e6e6e6 solid;
  padding-bottom: 10px;
}
.movie_body .pic_show {
  width: 64px;
  height: 90px;
}
.movie_body .pic_show img {
  width: 100%;
}
.movie_body .info_list {
  margin-left: 10px;
  flex: 1;
  position: relative;
}
.movie_body .info_list h2 {
  font-size: 17px;
  line-height: 24px;
  width: 150px;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}
.movie_body .info_list p {
  font-size: 13px;
  color: #666;
  line-height: 22px;
  width: 200px;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}
.movie_body .info_list .grade {
  font-weight: 700;
  color: #faaf00;
  font-size: 15px;
}
.movie_body .info_list img {
  width: 50px;
  position: absolute;
  right: 10px;
  top: 5px;
}
.movie_body .btn_mall,
.movie_body .btn_pre {
  width: 47px;
  height: 27px;
  line-height: 28px;
  text-align: center;
  background-color: #f03d37;
  color: #fff;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
}
.movie_body .btn_pre {
  background-color: #3c9fe6;
}
.movie_body .pullDown {
  margin: 0;
  padding: 0;
  border: none;
}
</style>

```

#### 7.2.9 Search组件

**代码**

```vue
<template>
  <div class="search_body">
    <div class="search_input">
      <div class="search_input_wrapper">
        <i class="iconfont icon-sousuo"></i>
        <input type="text">
      </div>					
    </div>
    <div class="search_result">
      <h3>电影/电视剧/综艺</h3>
      <ul>
        <li>
          <div class="img"><img src="images/movie_1.jpg"></div>
          <div class="info">
            <p><span>无名之辈</span><span>8.5</span></p>
            <p>A Cool Fish</p>
            <p>剧情,喜剧,犯罪</p>
            <p>2018-11-16</p>
          </div>
        </li>
        <li>
          <div class="img"><img src="images/movie_1.jpg"></div>
          <div class="info">
            <p><span>无名之辈</span><span>8.5</span></p>
            <p>A Cool Fish</p>
            <p>剧情,喜剧,犯罪</p>
            <p>2018-11-16</p>
          </div>
        </li>
      </ul>
    </div>
  </div>
</template>

<script>
export default {
  name: 'Search'
}
</script>

<style lang="scss" scoped>
#content .search_body {
  flex: 1;
  overflow: auto;
}
.search_body .search_input {
  padding: 8px 10px;
  background-color: #f5f5f5;
  border-bottom: 1px solid #e5e5e5;
}
.search_body .search_input_wrapper {
  padding: 0 10px;
  border: 1px solid #e6e6e6;
  border-radius: 5px;
  background-color: #fff;
  display: flex;
  line-height: 20px;
}
.search_body .search_input_wrapper i {
  font-size: 16px;
  padding: 4px 0;
}
.search_body .search_input_wrapper input {
  border: none;
  font-size: 13px;
  color: #333;
  padding: 4px 0;
  outline: none;
  margin-left: 5px;
  width: 100%;
}

.search_body .search_result h3 {
  font-size: 15px;
  color: #999;
  padding: 9px 15px;
  border-bottom: 1px solid #e6e6e6;
}
.search_body .search_result li {
  border-bottom: 1px #c9c9c9 dashed;
  padding: 10px 15px;
  box-sizing: border-box;
  display: flex;
}
.search_body .search_result .img {
  width: 60px;
  float: left;
}
.search_body .search_result .img img {
  width: 100%;
}
.search_body .search_result .info {
  float: left;
  margin-left: 15px;
  flex: 1;
}
.search_body .search_result .info p {
  height: 22px;
  display: flex;
  line-height: 22px;
  font-size: 12px;
}
.search_body .search_result .info p:nth-of-type(1) span:nth-of-type(1) {
  font-size: 18px;
  flex: 1;
}
.search_body .search_result .info p:nth-of-type(1) span:nth-of-type(2) {
  font-size: 16px;
  color: #fc7103;
}
</style>

```

## 8. 前后台交互 ajax 

- 本项目选择使用axios发送Ajax请求
- 首先项目需要安装axios ` npm install axios--save`

### 8.1 API文档

**具体API文档详见[项目API接口文档](./接口文档.md)，然后可以使用Postman来进行接口测试**

### 8.2 在main.js中引入axios

- 我们在Vue实例对象的原型上绑定axios方法

```javascript
import axios from 'axios'

Vue.prototype.axios = axios

```

### 8.3 配置代理并测试接口实现ajax请求

**问题分析：**

- 目前为止运行的所有页面都是静态页面

- 接下来先测试使用axios来异步获取数据

**配置代理并测试接口：**

1. 在根文件夹下创建vue.config.js文件里设置代理配置表 

```javascript
module.exports = {
  devServer: {
    proxy: {
      '/api': {
        target: 'http://39.97.33.178',
        changeOrigin: true
      }
    }
  }
}

```

2. 因为修改了项目的config文件，所以需要重启项目` npm run serve`

3. 此时可以在控制台看到代理请求到的数据

## 9. 请求接口后，完善各组件代码

**图片过滤器**

1. 接口获取到的图片的数据是(例子)
`"img":"http://p0.meituan.net/w.h/moviemachine/58ee13be6dc60bf5e636cf915bbbaaa55787785.jpg"`

2. URL中的w.h可以指定图片的像素比

3. 在main.js中注册一个全局过滤器

**图片过滤器代码**

```javascript
// 用arg替换w.h   正则表达式匹配w.h ==> /w\.h/
Vue.filter('setWH', (url, arg) => {
  return url.replace(/w\.h/, arg)
})

```

### 9.1 City组件

**代码**

```vue
<template>
  <div class="city_body">
    <div class="city_list">
      <div class="city_hot">
        <h2>热门城市</h2>
        <ul class="clearfix">
          <li v-for="item in hotList" :key="item.id">{{item.nm}}</li>
        </ul>
      </div>
      <div class="city_sort" ref="city_sort">
        <div v-for="item in cityList" :key="item.id">
          <h2>{{item.index}}</h2>
          <ul>
            <li v-for="itemList in item.list" :key="itemList.id">{{itemList.nm}}</li>
          </ul>
        </div>
      </div>
    </div>
    <div class="city_index">
      <ul>
        <li
          v-for="(item,index) in cityList"
          :key="item.index"
          @touchstart="handleToIndex(index)"
        >{{item.index}}</li>
      </ul>
    </div>
  </div>
</template>

<script>
export default {
  name: 'City',
  data () {
    return {
      cityList: [],
      hotList: []
    }
  },
  // 在mounted中发送Ajax请求
  mounted () {
    this.axios.get('/api/cityList').then(res => {
      console.log(res)
      const msg = res.data.msg
      if (msg === 'ok') {
        const cities = res.data.data.cities
        // [{index: 'A', list: [{nm: '阿城', id: 123}]}]
        const { cityList, hotList } = this.formatCityList(cities)
        this.cityList = cityList
        this.hotList = hotList
      }
    })
  },
  methods: {
    // 城市分组----城市列表和热门城市
    formatCityList (cities) {
      const cityList = []
      const hotList = []
      // 热门城市
      cities.map((e, i, arry) => {
        if (cities[i].isHot === 1) {
          hotList.push(cities[i])
        }
      })
      // 根据拼音来进行ABC分组
      cities.map((e, i, arr) => {  
        // 将城市拼音的第一个字母取出变成大写
        const firstLetter = cities[i].py.substring(0, 1).toUpperCase()
        if (toCom(firstLetter)) {  //新添加index
          cityList.push({
            index: firstLetter,
            list: [{ nm: cities[i].nm, id: cities[i].id }]
          })
        } else {  //累积到已有的index
          cityList.map((e, j, arr) => {
            if (cityList[j].index === firstLetter) {
              cityList[j].list.push({ nm: cities[i].nm, id: cities[i].id })
            }
          })
        }
      })
      // 判断拼音第一个字母和城市列表index相等(校验)
      function toCom (firstLetter) {
        for (let i = 0; i < cityList.length; i++) {
          if (cityList[i].index === firstLetter) {
            return false
          }
        }
        return true
      }
      // 对cityList进行排序，按照ABCDEFG...
      cityList.sort((n1, n2) => {
        if (n1.index > n2.index) {
          return 1
        } else if (n1.index < n2.index) {
          return -1
        } else {
          return 0
        }
      })
      console.log(cityList)
      console.log(hotList)
      return { cityList, hotList }
    },
    // 绑定移动端touch事件----点击城市列表index，跳转到相应的城市
    handleToIndex (index) {
      // console.log(index) 城市列表下标
      // 获取到city_sort下的h2标签
      const h2 = this.$refs.city_sort.getElementsByTagName('h2')
      this.$refs.city_sort.parentNode.scrollTop = h2[index].offsetTop
    }
  }
}
</script>

```

### 9.2 NowPlaying组件

**代码**

```vue
<template>
  <div class="movie_body">
    <ul>
      <li v-for="item in movieList" :key="item.id">
        <div class="pic_show">
          <img :src="item.img | setWH('128.180')" />
        </div>
        <div class="info_list">
          <h2>{{item.nm}}<img v-if="item.version" src="@/assets/maxs.png"></h2>
          <p>
            观众评分：
            <span class="grade">{{item.sc}}</span>
          </p>
          <p>主演:{{item.star}}</p>
          <p>{{item.showInfo}}</p>
        </div>
        <div class="btn_mall">购票</div>
      </li>
    </ul>
  </div>
</template>

<script>
export default {
  name: 'NowPlaying',
  data () {
    return {
      movieList: []
    }
  },
  mounted () {
    this.axios.get('/api/movieOnInfoList?cityId=10').then(res => {
      console.log(res)
      const msg = res.data.msg
      if (msg === 'ok') {
        this.movieList = res.data.data.movieList
        console.log(this.movieList)
      }
    })
  }
}
</script>

```

### 9.3 ComingSoon组件

**代码**

```vue
<template>
  <div class="movie_body">
    <ul>
      <li v-for="item in comingList" :key="item.id">
        <div class="pic_show">
          <img :src="item.img | setWH('128.180')" />
        </div>
        <div class="info_list">
          <h2>{{item.nm}}<img src="@/assets/maxs.png" v-if="item.sc"></h2>
          <p>
            <span class="person">{{item.wish}}</span> 人想看
          </p>
          <p>主演: {{item.star}}</p>
          <p>{{item.rt}} 上映</p>
        </div>
        <div class="btn_pre">预售</div>
      </li>
    </ul>
  </div>
</template>

<script>
export default {
  name: 'ComingSoon',
  data () {
    return {
      comingList: []
    }
  },
  mounted () {
    this.axios.get('/api/movieComingList?cityId=10').then((res) => {
      console.log(res)
      const msg = res.data.msg
      if (msg === 'ok') {
        this.comingList = res.data.data.comingList
        console.log(this.comingList)
      }
    })
  }
}
</script>

```

### 9.4 CinemaList组件

**代码**

```vue
<template>
  <div class="cinema_body">
    <ul>
      <li v-for="item in cinemas" :key="item.id">
        <div>
          <span>{{item.nm}}</span>
          <span class="q">
            <span class="price">{{item.sellPrice}}</span> 元起
          </span>
        </div>
        <div class="address">
          <span>{{item.addr}}</span>
          <span>{{item.distance}}</span>
        </div>
        <div class="card">
          <div
            v-for="(value,name) in item.tag"
            v-show="value === 1"
            :key="name"
            :class="name | classTag"
          >{{name | formatTag}}</div>
        </div>
      </li>
    </ul>
  </div>
</template>

<script>
export default {
  name: 'CinemaList',
  data () {
    return {
      cinemas: []
    }
  },
  mounted () {
    this.axios.get('/api/cinemaList?cityId=10').then(res => {
      console.log(res)
      const msg = res.data.msg
      if (msg === 'ok') {
        this.cinemas = res.data.data.cinemas
        console.log(this.cinemas)
      }
    })
  },
  // 组件内的过滤器
  filters: {
    formatTag (name) {
      // 格式化tag,为tag添加值
      const tags = [
        { key: 'allowRefund', value: '改签' },
        { key: 'endorse', value: '退' },
        { key: 'sell', value: '折扣卡' },
        { key: 'snack', value: '小吃' }
      ]
      // console.log(tags)
      // tags.map((e, i, arr) => {
      //   if (tags[i].key === name) {
      //     return tags[i].value
      //   }
      // })
      // return ''
      return (
        (tags.find(e => e.key === name) &&
          tags.find(e => e.key === name).value) ||
        ''
      )
    },
    classTag (name) {
      // 为tag添加类
      const tags = [
        { key: 'allowRefund', value: 'bl' },
        { key: 'endorse', value: 'bl' },
        { key: 'sell', value: 'or' },
        { key: 'snack', value: 'or' }
      ]
      return (
        (tags.find(e => e.key === name) &&
          tags.find(e => e.key === name).value) ||
        ''
      )
    }
  }
}
</script>

```

### 9.5 Search组件

**代码**

```vue
<template>
  <div class="search_body">
    <div class="search_input">
      <div class="search_input_wrapper">
        <i class="iconfont icon-sousuo"></i>
        <input type="text" v-model="message" />
      </div>
    </div>
    <div class="search_result">
      <h3>电影/电视剧/综艺</h3>
      <ul>
        <li v-for="item in moviesList" :key="item.id">
          <div class="img">
            <img :src="item.img | setWH('128.180')" />
          </div>
          <div class="info">
            <p>
              <span>{{item.nm}}</span>
              <span>{{item.sc}}</span>
            </p>
            <p>{{item.enm}}</p>
            <p>{{item.cat}}</p>
            <p>{{item.rt}}</p>
          </div>
        </li>
      </ul>
    </div>
  </div>
</template>

<script>
import { clearTimeout, setTimeout } from 'timers'
export default {
  name: 'Search',
  data () {
    return {
      message: '',
      moviesList: []
    }
  },
  methods: {
    // 取消请求函数
    cancelRequest () {
      if (typeof this.source === 'function') {
        this.source('终止请求')
      }
    }
  },
  watch: {
    // axios 请求频繁时取消上一次请求
    message (newValue) {
      console.log(newValue)
      this.cancelRequest()
      let that = this
      this.axios.get('/api/searchList?cityId=10&kw=a' + newValue, {
        cancelToken: new this.axios.CancelToken(function (c) {
          that.source = c
        })
      }).then(res => {
        console.log(res)
        const msg = res.data.msg
        const movies = res.data.data.movies
        if (msg && movies) {
          this.moviesList = res.data.data.movies.list
          console.log(this.moviesList)
        }
      }).catch((err) => {
        if (this.axios.isCancel(err)) {
          // 请求如果被取消，这里是返回的取消的message
          console.log('Rquest canceled', err.message) 
        } else {
          // handle error
          console.log(err)
        }
      })
    }
  }
}
</script>

```

## 10. 功能组件的封装

### 10.1 封装Scroller组件

- 安装BetterScroll `npm install @better-scroll/core@next --save`

- [BetterScroll中文官网](https://better-scroll.github.io/docs/zh-CN/)

- wrapper就是父容器，它会有固定的高度。content是父容器的第一个子元素，它的高度会随着内容的大小而撑高。那么，当 content 的高度不超过父容器的高度，是不能滚动的，而它一旦超过了父容器的高度，我们就可以滚动内容区了，这就是 BetterScroll 的滚动原理。

- 封装better-scroll组件，提高代码的复用率，slot插槽分发子元素content。

**代码**

```vue
<template>
  <div class="wrapper" ref="wrapper">
    <slot></slot>
  </div>
</template>

<script>
import BScroll from '@better-scroll/core'
export default {
  name: 'Scroll',
  props: {
    handleToScroll: {
      type: Function,
      default: function () {}
    },
    handleToTouchEnd: {
      type: Function,
      default: function () {}
    }
  },
  mounted () {
    this.$nextTick(() => {
      const bscroll = new BScroll(this.$refs.wrapper, {
        tap: 'tap',
        probeType: 1
      })
      this.bscroll = bscroll
      bscroll.on('scroll', (pos) => {
        this.handleToScroll(pos)
      })
      bscroll.on('touchEnd', (pos) => {
        this.handleToTouchEnd(pos)
      })
      setTimeout(() => {
        bscroll.refresh()
      }, 500)
    })
  },
  methods: {
    toScrollTop (y) {
      this.bscroll.scrollTo(0, y)
    }
  }
}
</script>

<style lang="scss" scoped>
.wrapper{
  height: 100%;
}
</style>

```

- 在main.js中全局引入Scroller组件

```javascript
import Scroller from '@/components/Scroller'

Vue.component('Scroller', Scroller)
```

- 分别给CinemaList/City/ComingSoon/NowPlaying组件引入Scroller

### 10.2 封装loading组件

- 当请求接口时，我们需要一个loading遮挡层，请求成功才显示数据

**代码**

```vue
<template>
  <div class="loader"></div>
</template>

<script>
export default {
  name: 'Loading'
}
</script>

<style lang="scss" scoped>
.loader {
  position: relative;
  width: 2.5em;
  height: 2.5em;
  transform: rotate(165deg);
}
.loader:before,
.loader:after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  display: block;
  width: 0.5em;
  height: 0.5em;
  border-radius: 0.25em;
  transform: translate(-50%, -50%);
}
.loader:before {
  animation: before 2s infinite;
}
.loader:after {
  animation: after 2s infinite;
}
@keyframes before {
  0% {
    width: 0.5em;
    box-shadow: 1em -0.5em rgba(225, 20, 98, 0.75),
      -1em 0.5em rgba(111, 202, 220, 0.75);
  }
  35% {
    width: 2.5em;
    box-shadow: 0 -0.5em rgba(225, 20, 98, 0.75),
      0 0.5em rgba(111, 202, 220, 0.75);
  }
  70% {
    width: 0.5em;
    box-shadow: -1em -0.5em rgba(225, 20, 98, 0.75),
      1em 0.5em rgba(111, 202, 220, 0.75);
  }
  100% {
    box-shadow: 1em -0.5em rgba(225, 20, 98, 0.75),
      -1em 0.5em rgba(111, 202, 220, 0.75);
  }
}
@keyframes after {
  0% {
    height: 0.5em;
    box-shadow: 0.5em 1em rgba(61, 184, 143, 0.75),
      -0.5em -1em rgba(233, 169, 32, 0.75);
  }
  35% {
    height: 2.5em;
    box-shadow: 0.5em 0 rgba(61, 184, 143, 0.75),
      -0.5em 0 rgba(233, 169, 32, 0.75);
  }
  70% {
    height: 0.5em;
    box-shadow: 0.5em -1em rgba(61, 184, 143, 0.75),
      -0.5em 1em rgba(233, 169, 32, 0.75);
  }
  100% {
    box-shadow: 0.5em 1em rgba(61, 184, 143, 0.75),
      -0.5em -1em rgba(233, 169, 32, 0.75);
  }
}
/**
 * Attempt to center the whole thing!
 */
html,
body {
  height: 100%;
}
.loader {
  position: absolute;
  top: calc(50% - 1.25em);
  left: calc(50% - 1.25em);
}
</style>

```

- 在main.js中全局引入Loading组件

```javascript
import Loading from '@/components/Loading'

Vue.component('Loading', Loading)
```

- 分别给CinemaList/City/ComingSoon/NowPlaying组件引入Loading

```vue
<Loading v-if="isLoading"></Loading>
<Scroller v-else>
  ...content
</Scroller>

data() {
  isLoading: true
}

//请求接口时
this.isLoading = true

//请求成功时
this.isLoading = false
```

### 10.3 封装MessageBox组件

- 当重新刷新页面时，会定位到当前城市，弹出一个Message框

- 创建JS文件夹，用于存放MessagesBox组件及相关javascript代码

**vue组件代码**

```vue
<template>
  <div class="messageBox">
    <h2>{{title}}</h2>
    <p>{{content}}</p>
    <div>
      <div @touchstart='handleCancel'>{{cancel}}</div>
      <div @touchstart='handleOk'>{{ok}}</div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'MessageBox'
}
</script>

<style lang="scss" scoped>
.messageBox {
  width: 200px;
  height: 120px;
  border: 1px solid #cccccc;
  border-radius: 4px;
  background: white;
  box-shadow: 3px 3px 3px 3px #cccccc;
  position: absolute;
  left: 50%;
  top: 50%;
  margin: -60px 0 0 -100px;
}
.messageBox h2 {
  text-align: center;
  line-height: 40px;
  font-size: 18px;
}
.messageBox p {
  text-align: center;
  line-height: 40px;
}
.messageBox > div{
  display: flex;
  position: absolute;
  bottom: 0;
  width: 100%;
  border-top: 1px solid #cccccc;
}
.messageBox > div div{
  flex: 1;
  text-align: center;
  line-height: 30px;
  border-right: 1px solid #cccccc;
}
.messageBox > div div:last-child{
  border: none;
}
</style>

```

**js代码**

```javascript
import Vue from 'vue'
import MessageBox from './MessageBox'

export const messageBox = (() => {
  const defaults = { // 默认值
    title: '',
    content: '',
    cancel: '',
    ok: '',
    handleCancel: null,
    handleOk: null
  }

  const MyComponent = Vue.extend(MessageBox)

  return (opts) => {
    for (const attr in opts) {
      defaults[attr] = opts[attr]
    }

    const vm = new MyComponent({
      el: document.createElement('div'),
      data () {
        return {
          title: defaults.title,
          content: defaults.content,
          cancel: defaults.cancel,
          ok: defaults.ok
        }
      },
      methods: {
        handleCancel () {
          defaults.handleCancel && defaults.handleCancel.call(this)
          document.body.removeChild(vm.$el)
        },
        handleOk () {
          defaults.handleOk && defaults.handleOk.call(this)
          document.body.removeChild(vm.$el)
        }
      }
    })

    document.body.appendChild(vm.$el)
  }
})()

```

## 11. 使用Vuex管理状态

- 安装Vuex(vue-cli已安装)` npm install vuex --save` 用来管理从后台获取的状态数据

### 11.1 创建Store(核心仓库)

- 在项目的store文件夹下新建index.js

```javascript
import Vue from 'vue'
import Vuex from 'vuex'
import City from './City'

Vue.use(Vuex)

export default new Vuex.Store({
  state: {

  },
  getters: {

  },
  mutations: {

  },
  actions: {

  },
  modules: {
    City
  }
})

```

### 11.2 模块对象City

- 在项目的store文件夹下新建City模块

- 在City模块下的index.js 文件中管理city数据

```javascript
const state = {
  nm: window.localStorage.getItem('nowNm') || '北京',
  id: window.localStorage.getItem('nowId') || 1
}

const actions = {

}

const mutations = {
  CITY_INFO (state, payload) {
    state.nm = payload.nm
    state.id = payload.id
  }
}

export default {
  namespaced: true,
  state,
  actions,
  mutations
}

```

### 11.3 修改组件中的city数据

#### 11.3.1 CinemaList组件

- 在Scroller组件上绑定handleToScroll和handleToTouchEnd事件

- 当向下滑动超过30，重新请求接口。

- 下拉时` 正在更行中...` ，停止下拉` 更行成功`

```vue
<Scroller v-else :handleToScroll='handleToScroll' :handleToTouchEnd='handleToTouchEnd'>
  <ul>
    <li class="pullDown">{{pullDownMsg}}</li>
    ...
  </ul>
</Scroller>
```

```javascript
data () {
  prevCityId: -1
},
activated () {
  const cityId = this.$store.state.City.id
  if (this.prevCityId === cityId) { return }
  this.isLoading = true
  this.axios.get('/api/cinemaList?cityId=' + cityId).then(res => {
    console.log(res)
    const msg = res.data.msg
    if (msg === 'ok') {
      this.cinemas = res.data.data.cinemas
      console.log(this.cinemas)
      this.prevCityId = cityId
      this.isLoading = false
    }
  })
},
methods: {
  handleToScroll (pos) {
    if (pos.y > 30) {
      this.pullDownMsg = '正在更新中...'
    }
  },
  handleToTouchEnd (pos) {
    const cityId = this.$store.state.City.id
    if (pos.y > 30) {
      this.axios.get('/api/cinemaList?cityId=' + cityId).then(res => {
        console.log(res)
        const msg = res.data.msg
        if (msg === 'ok') {
          this.pullDownMsg = '更新成功'
          setTimeout(() => {
            this.cinemas = res.data.data.cinemas
            console.log(this.cinemas)
            this.pullDownMsg = ''
          }, 1000)
        }
      })
    }
  }
}

```

#### 11.3.2 City组件

- 在热门城市和城市列表中绑定tap事件

```vue
<li v-for="item in hotList" :key="item.id"
  @tap="handleToCity(item.nm,item.id)"
>{{item.nm}}</li>

<li v-for="itemList in item.list" :key="itemList.id"
  @tap="handleToCity(itemList.nm,itemList.id)"
>{{itemList.nm}}</li>
```

```javascript
mounted () {
  const cityList = window.localStorage.getItem('cityList')
  const hotList = window.localStorage.getItem('hotList')
  if (cityList && hotList) {
    this.cityList = JSON.parse(cityList)
    this.hotList = JSON.parse(hotList)
    this.isLoading = false
  } else {
    this.axios.get('/api/cityList').then(res => {
      console.log(res)
      const msg = res.data.msg
      if (msg === 'ok') {
        const cities = res.data.data.cities
        const { cityList, hotList } = this.formatCityList(cities)
        this.cityList = cityList
        this.hotList = hotList
        window.localStorage.setItem('cityList', JSON.stringify(cityList))
        window.localStorage.setItem('hotList', JSON.stringify(hotList))
        this.isLoading = false
      }
    })
  }
},
methods: {
  handleToIndex (index) {
    // console.log(index)
    const h2 = this.$refs.city_sort.getElementsByTagName('h2')
    this.$refs.city_sort.parentNode.scrollTop = h2[index].offsetTop
    // this.$refs.city_sort.parentNode.scrollTop = h2[index].offsetTop
    this.$refs.city_list.toScrollTop(-h2[index].offsetTop)
  },
  handleToCity (nm, id) {
    this.$store.commit('City/CITY_INFO', { nm, id })
    window.localStorage.setItem('nowNm', nm)
    window.localStorage.setItem('nowId', id)
    this.$router.push('/movie/nowPlaying')
  }
}

```

#### 11.3.3 ComingSoon组件

- 在Scroller组件上绑定handleToScroll和handleToTouchEnd事件

- 当向下滑动超过30，重新请求接口。

- 下拉时` 正在更行中...` ，停止下拉` 更行成功`

```vue
<Scroller v-else ref="scroller":handleToScroll='handleToScroll'
  :handleToTouchEnd='handleToTouchEnd'
>
  <ul>
    <li class="pullDown">{{pullDownMsg}}</li>
    ...
  </ul>
</Scroller>

```

```javascript
data () {
  prevCityId: -1
},
activated () {
  const cityId = this.$store.state.City.id
  if (this.prevCityId === cityId) { return }
  this.isLoading = true
  this.axios.get('/api/movieComingList?cityId=' + cityId).then(res => {
    console.log(res)
    const msg = res.data.msg
    if (msg === 'ok') {
      this.comingList = res.data.data.comingList
      console.log(this.comingList)
      this.prevCityId = cityId
      this.isLoading = false
    }
  })
},
methods: {
  handleToScroll (pos) {
    if (pos.y > 30) {
      this.pullDownMsg = '正在更新中...'
    }
  },
  handleToTouchEnd (pos) {
    const cityId = this.$store.state.City.id
    if (pos.y > 30) {
      this.axios.get('/api/movieComingList?cityId=' + cityId).then(res => {
        console.log(res)
        const msg = res.data.msg
        if (msg === 'ok') {
          this.pullDownMsg = '更新成功'
          setTimeout(() => {
            this.comingList = res.data.data.comingList
            console.log(this.comingList)
            this.pullDownMsg = ''
          }, 1000)
        }
      })
    }
  }
}

```

#### 11.3.4 NowPlaying组件

- 在Scroller组件上绑定handleToScroll和handleToTouchEnd事件

- 当向下滑动超过30，重新请求接口。

- 下拉时` 正在更行中...` ，停止下拉` 更行成功`

```vue
<Scroller v-else ref="scroller":handleToScroll='handleToScroll'
  :handleToTouchEnd='handleToTouchEnd'
>
...
</Scroller>

```

```javascript
data () {
  prevCityId: -1
},
activated () {
  const cityId = this.$store.state.City.id
  if (this.prevCityId === cityId) { return }
  this.isLoading = true
  this.axios.get('/api/movieOnInfoList?cityId=' + cityId).then(res => {
    console.log(res)
    const msg = res.data.msg
    if (msg === 'ok') {
      this.movieList = res.data.data.movieList
      console.log(this.movieList)
      this.prevCityId = cityId
      this.isLoading = false
    }
  })
},
methods: {
  handleToScroll (pos) {
    if (pos.y > 30) {
      this.pullDownMsg = '正在更新中...'
    }
  },
  handleToTouchEnd (pos) {
    const cityId = this.$store.state.City.id
    if (pos.y > 30) {
      this.axios.get('/api/movieOnInfoList?cityId=' + cityId).then(res => {
        console.log(res)
        const msg = res.data.msg
        if (msg === 'ok') {
          this.pullDownMsg = '更新成功'
          setTimeout(() => {
            this.movieList = res.data.data.movieList
            console.log(this.movieList)
            this.pullDownMsg = ''
          }, 1000)
        }
      })
    }
  }
}

```

#### 11.3.5 Movie组件

- 在Movie组件中引入messageBox

```vue
<router-link to="/movie/city" tag="div" class="city_name">
  <span>大连</span>
  <span>{{$store.state.City.nm}}</span>
  <i class="iconfont icon-lower-triangle"></i>
</router-link>

```

```javascript
import { messageBox } from '@/components/JS'

mounted () {
  setTimeout(() => {
    this.axios.get('/api/getLocation').then(res => {
      console.log(res)
      const msg = res.data.msg
      if (msg === 'ok') {
        const nm = res.data.data.nm
        const id = res.data.data.id
        // eslint-disable-next-line eqeqeq
        if (this.$store.state.City.id == id) { return }
        messageBox({
          title: '定位',
          content: nm,
          cancel: '取消',
          ok: '切换定位',
          // handleCancel () {
          //   console.log(1)
          // },
          handleOk () {
            window.localStorage.setItem('nowNm', nm)
            window.localStorage.setItem('nowId', id)
            window.location.reload()
          }
        })
      }
    })
  }, 3000)
}

```

## 12. detail电影详情页

- 点击正在热映和即将上映的电影图片，会跳转进入相应的detail电影详情页

- 电影详情图片展示将用到` vue-awesome-swiper`来实现图片的滑动

- 下载安装` npm install vue-awesome-swiper --save`

**代码**

```vue
/* eslint-disable no-undef */
<template>
  <div id="detailContrainer" class="slide-enter-active">
    <Header title="影片详情">
      <!-- 绑定返回事件 -->
      <i class="iconfont icon-right" @touchstart="handleToBack"></i>
    </Header>
    <!-- Loading遮挡层 -->
    <Loading v-if="isLoading" />
    <div v-else id="content" class="contentDetail">
      <div class="detail_list">
        <div class="detail_list_bg" :style="{'background-image': 'url('+ detailMovie.img.replace(/w\.h/,'148.208') +')'}"></div>
        <div class="detail_list_filter"></div>
        <div class="detail_list_content">
          <div class="detail_list_img">
            <img :src="detailMovie.img | setWH('148.208')" alt />
          </div>
          <div class="detail_list_info">
            <h2>{{detailMovie.nm}}</h2>
            <p>{{detailMovie.enm}}</p>
            <p>{{detailMovie.sc}}</p>
            <p>{{detailMovie.cat}}</p>
            <p>{{detailMovie.src}} / {{detailMovie.dur}}分钟</p>
            <p>{{detailMovie.pubDesc}}</p>
          </div>
        </div>
      </div>
      <div class="detail_intro">
        <p>{{detailMovie.dra}}</p>
      </div>
      <div class="detail_player swiper-container" ref="detail_player">
        <!-- 电影详情图片使用vue-awesome-swiper实现滑动 -->
        <swiper :options="swiperOption" class="swiper-wrapper">
          <swiper-slide class="swiper-slide" v-for="(item,index) in detailMovie.photos" :key="index">
            <div>
              <img :src="item | setWH('140.127')" alt />
            </div>
          </swiper-slide>
        </swiper>
      </div>
    </div>
  </div>
</template>

<script>
import Header from '@/components/Header'
export default {
  name: 'Detail',
  components: {
    Header
  },
  data () {
    return {
      detailMovie: {},
      isLoading: true,
      // vue-awesome-swiper配置
      swiperOption: {
        slidesPerView: 'auto',
        freeMode: true,
        freeModeSticky: true
      }
    }
  },
  // 路由传参
  props: ['movieId'],
  methods: {
    // 编程式导航
    handleToBack () {
      this.$router.back()
    }
  },
  mounted () {
    // console.log(this.movieId)
    this.axios.get('/api/detailmovie?movieId=' + this.movieId).then(res => {
      console.log(res)
      const msg = res.data.msg
      if (msg === 'ok') {
        this.detailMovie = res.data.data.detailMovie

        this.isLoading = false
      }
    })
  }
}
</script>

<style lang="scss" scoped>
#detailContrainer {
  position: absolute;
  left: 0;
  top: 0;
  z-index: 100;
  width: 100%;
  min-height: 100%;
  background: white;
}
#detailContrainer.slide-enter-active {
  animation: 0.3s slideMove;
}
@keyframes slideMove {
  0% {
    transform: translateX(100%);
  }
  100% {
    transform: translateX(0);
  }
}
#content.contentDetail {
  display: block;
  margin-bottom: 0;
}
#content .detail_list {
  height: 200px;
  width: 100%;
  position: relative;
  overflow: hidden;
}
.detail_list .detail_list_bg {
  width: 100%;
  height: 100%;
  background: 0 40%;
  filter: blur(20px);
  background-size: cover;
  position: absolute;
  left: 0;
  top: 0;
}
.detail_list .detail_list_filter {
  width: 100%;
  height: 100%;
  position: absolute;
  background-color: #40454d;
  opacity: 0.55;
  position: absolute;
  left: 0;
  top: 0;
  z-index: 1;
}
.detail_list .detail_list_content {
  display: flex;
  width: 100%;
  height: 100%;
  position: absolute;
  left: 0;
  top: 0;
  z-index: 2;
}
.detail_list .detail_list_img {
  width: 108px;
  height: 150px;
  border: solid 1px #f0f2f3;
  margin: 20px;
}
.detail_list .detail_list_img img {
  width: 100%;
  height: 100%;
}
.detail_list .detail_list_info {
  margin-top: 20px;
}
.detail_list .detail_list_info h2 {
  font-size: 20px;
  color: white;
  font-weight: normal;
  line-height: 40px;
}
.detail_list .detail_list_info p {
  color: white;
  line-height: 20px;
  font-size: 14px;
  color: #ccc;
}
#content .detail_intro {
  padding: 10px;
}
#content .detail_player {
  margin: 20px;
}
.detail_player .swiper-slide {
  width: 70px;
  margin-right: 20px;
  text-align: center;
  font-size: 14px;
}
.detail_player .swiper-slide img {
  width: 100%;
  margin-bottom: 5px;
}
.detail_player .swiper-slide p:nth-of-type(2) {
  color: #999;
}
</style>

```

- 通过路由传参，在movie路由中配置两个detail电影页的路由

```javascript
{
  path: 'detail/1/:movieId',
  components: {
    default: () => import('@/components/NowPlaying'),
    detail: () => import('@/views/Movie/detail')
  },
  props: {
    detail: true
  }
},
{
  path: 'detail/2/:movieId',
  components: {
    default: () => import('@/components/ComingSoon'),
    detail: () => import('@/views/Movie/detail')
  },
  props: {
    detail: true
  }
}

```

- 在ComingSoon和NowPlaying组件中配置路由的跳转

```javascript
handleToDetail (movieId) {
  // console.log(movieId)
  this.$router.push('/movie/detail/1/' + movieId)
}

```
